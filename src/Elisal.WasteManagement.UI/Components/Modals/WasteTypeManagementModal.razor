@using Elisal.WasteManagement.Domain.Entities
@inject HttpClient Http
@inject Elisal.WasteManagement.UI.Services.NotificationService NotificationService

@if (IsVisible)
{
    <div class="fixed inset-0 z-[60] overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <div class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm transition-opacity" @onclick="Close"></div>
        <div class="flex min-h-full items-center justify-center p-4">
            <div class="relative w-full max-w-4xl transform overflow-hidden rounded-2xl bg-white dark:bg-slate-900 text-left shadow-2xl transition-all border border-slate-200 dark:border-slate-800">
                <!-- Header -->
                <div class="px-6 sm:px-8 py-4 sm:py-5 border-b border-slate-200 dark:border-slate-800 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 bg-slate-50/50 dark:bg-slate-800/50">
                    <div>
                        <h3 class="text-lg sm:text-xl font-bold text-slate-900 dark:text-white" id="modal-title">Gestão de Tipos de Resíduos</h3>
                        <p class="text-[10px] sm:text-xs text-slate-500 dark:text-slate-400 mt-0.5">Configure as categorias e propriedades de descarte</p>
                    </div>
                    <div class="flex items-center gap-2 sm:gap-3 w-full sm:w-auto">
                        <button @onclick="ShowNewForm" class="flex-1 sm:flex-none flex items-center justify-center gap-2 px-3 sm:px-4 py-2 bg-primary text-white rounded-lg text-xs sm:text-sm font-bold hover:bg-primary/90 transition-all shadow-sm">
                            <span class="material-symbols-outlined text-lg">add</span>
                            Adicionar
                        </button>
                        <button @onclick="Close" class="p-2 text-slate-400 hover:text-slate-600 dark:hover:text-white transition-colors">
                            <span class="material-symbols-outlined">close</span>
                        </button>
                    </div>
                </div>

                <div class="p-8">
                    @if (showForm)
                    {
                        <!-- Inline Edit/Create Form -->
                        <div class="mb-8 p-6 rounded-xl border-2 border-primary/20 bg-primary/5 dark:bg-primary/10">
                            <h4 class="text-sm font-bold uppercase tracking-wider text-primary mb-4">@(editingId == 0 ? "Nova Categoria" : "Editar Categoria")</h4>
                            <EditForm Model="@model" OnValidSubmit="SaveTipo">
                                <DataAnnotationsValidator/>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-end">
                                    <div class="space-y-1.5">
                                        <label class="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase">Cor de Identificação</label>
                                        <div class="flex items-center gap-3">
                                            <InputText @bind-Value="model.ColorCode" type="color" class="h-10 w-20 rounded-lg border-slate-200 dark:border-slate-700 cursor-pointer p-1 bg-white dark:bg-slate-800"/>
                                            <span class="text-xs text-slate-600 dark:text-slate-400 font-mono">@(string.IsNullOrEmpty(model.ColorCode) ? "#000000" : model.ColorCode)</span>
                                        </div>
                                    </div>
                                    <div class="space-y-1.5">
                                        <label class="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase">Nome</label>
                                        <div class="flex items-center gap-3">
                                            <InputText @bind-Value="model.Name" type="text" class="h-10 w-full rounded-lg border-slate-200 dark:border-slate-700 cursor-pointer p-1 bg-white dark:bg-slate-800"/>
                                        </div>
                                    </div>
                                    <div class="flex items-center gap-6 h-10">
                                        <label class="flex items-center gap-3 cursor-pointer group">
                                            <div class="relative flex items-center">
                                                <InputCheckbox @bind-Value="model.IsRecyclable" class="peer h-5 w-5 rounded border-slate-300 text-primary focus:ring-primary"/>
                                            </div>
                                            <span class="text-sm font-semibold text-slate-700 dark:text-slate-300 group-hover:text-primary transition-colors">É reciclável?</span>
                                        </label>

                                        <div class="flex flex-1 justify-end gap-2">
                                            <button type="button" @onclick="() => showForm = false" class="px-4 py-2 text-sm font-bold text-slate-500 hover:text-slate-700 transition-colors">Cancelar</button>
                                            <button type="submit" class="px-6 py-2 bg-primary text-white rounded-lg text-sm font-bold shadow-md hover:translate-y-[-1px] transition-all">
                                                Salvar Alterações
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </EditForm>
                        </div>
                    }

                    <!-- List Table -->
                    <div class="bg-white dark:bg-slate-900 rounded-xl border border-slate-200 dark:border-slate-800 shadow-sm overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full text-left">
                                <thead class="bg-slate-50 dark:bg-slate-800/50 border-b border-slate-200 dark:border-slate-800">
                                <tr>
                                    <th class="px-6 py-4 text-xs font-bold text-slate-500 uppercase tracking-widest whitespace-nowrap">Nome</th>
                                    <th class="px-6 py-4 text-xs font-bold text-slate-500 uppercase tracking-widest whitespace-nowrap">Reciclável</th>
                                    <th class="px-6 py-4 text-xs font-bold text-slate-500 uppercase tracking-widest text-right whitespace-nowrap">Ações</th>
                                </tr>
                                </thead>
                                <tbody class="divide-y divide-slate-100 dark:divide-slate-800">
                                @if (tipos == null)
                                {
                                    <tr>
                                        <td colspan="3" class="px-6 py-12 text-center">
                                            <div class="flex flex-col items-center gap-2">
                                                <span class="animate-spin material-symbols-outlined text-primary text-3xl">progress_activity</span>
                                                <span class="text-slate-400 text-sm font-medium">Sincronizando categorias...</span>
                                            </div>
                                        </td>
                                    </tr>
                                }
                                else if (!tipos.Any())
                                {
                                    <tr>
                                        <td colspan="3" class="px-6 py-12 text-center text-slate-400 italic text-sm">Nenhuma categoria configurada no momento.</td>
                                    </tr>
                                }
                                else
                                {
                                    @foreach (var t in tipos)
                                    {
                                        <tr class="hover:bg-slate-50/50 dark:hover:bg-slate-800/30 transition-colors">
                                            <td class="px-6 py-4 whitespace-nowrap">
                                                <div class="flex items-center gap-3">
                                                    <div class="size-3 rounded-full shadow-[0_0_8px_rgba(0,0,0,0.1)] border border-slate-200 dark:border-slate-700" style="background-color: @(string.IsNullOrEmpty(t.ColorCode) ? (t.IsRecyclable ? "#22c55e" : "#cbd5e1") : t.ColorCode)"></div>
                                                    <span class="font-bold text-slate-900 dark:text-white">@t.Name</span>
                                                </div>
                                            </td>
                                            <td class="px-6 py-4 whitespace-nowrap">
                                                @if (t.IsRecyclable)
                                                {
                                                    <span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400 text-[10px] font-black uppercase tracking-wider">
                                                        <span class="size-1 bg-green-500 rounded-full animate-pulse"></span>
                                                        Sim
                                                    </span>
                                                }
                                                else
                                                {
                                                    <span class="px-2.5 py-1 rounded-full bg-slate-100 dark:bg-slate-800 text-slate-500 dark:text-slate-400 text-[10px] font-black uppercase tracking-wider">Não</span>
                                                }
                                            </td>
                                            <td class="px-6 py-4 text-right whitespace-nowrap">
                                                <div class="flex justify-end gap-1">
                                                    <button @onclick="() => EditTipo(t)" class="p-2 text-slate-400 hover:text-primary hover:bg-primary/10 rounded-lg transition-all" title="Editar">
                                                        <span class="material-symbols-outlined text-xl">edit</span>
                                                    </button>
                                                    <button @onclick="() => ConfirmDelete(t.Id)" class="p-2 text-slate-400 hover:text-red-500 hover:bg-red-500/10 rounded-lg transition-all" title="Excluir">
                                                        <span class="material-symbols-outlined text-xl">delete</span>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    }
                                }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Footer -->
                <div class="px-8 py-4 border-t border-slate-200 dark:border-slate-800 bg-slate-50/50 dark:bg-slate-800/50 text-right">
                    <button @onclick="Close" class="px-5 py-2 text-sm font-bold text-slate-600 dark:text-slate-400 hover:bg-slate-200 dark:hover:bg-slate-700 rounded-lg transition-colors">Fechar Painel</button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    public bool IsVisible { get; private set; }
    private List<WasteType>? tipos;
    private bool showForm = false;
    private WasteType model = new();
    private int editingId = 0;

    public async void Show()
    {
        IsVisible = true;
        showForm = false;
        editingId = 0;
        await LoadData();
        StateHasChanged();
    }

    public void Close()
    {
        IsVisible = false;
        StateHasChanged();
    }

    private async Task LoadData()
    {
        try
        {
            tipos = await Http.GetFromJsonAsync<List<WasteType>>("api/residuos/tipos");
        }
        catch (Exception ex)
        {
            NotificationService.ShowError("Falha ao carregar categorias.");
        }
    }

    private void ShowNewForm()
    {
        model = new WasteType();
        editingId = 0;
        showForm = true;
    }

    private void EditTipo(WasteType t)
    {
        model = new WasteType { Id = t.Id, Name = t.Name, IsRecyclable = t.IsRecyclable, ColorCode = t.ColorCode };
        editingId = t.Id;
        showForm = true;
    }

    private async Task SaveTipo()
    {
        try
        {
            HttpResponseMessage response;
            if (editingId == 0)
            {
                response = await Http.PostAsJsonAsync("api/residuos/tipos", model);
                if (response.IsSuccessStatusCode) NotificationService.ShowSuccess("Categoria criada!");
            }
            else
            {
                response = await Http.PutAsJsonAsync($"api/residuos/tipos/{editingId}", model);
                if (response.IsSuccessStatusCode) NotificationService.ShowSuccess("Categoria atualizada!");
            }

            if (response.IsSuccessStatusCode)
            {
                showForm = false;
                await LoadData();
            }
            else
            {
                NotificationService.ShowError("Erro ao salvar operação.");
            }
        }
        catch (Exception ex)
        {
            NotificationService.ShowError("Erro técnico ao salvar.");
        }
    }

    private async Task ConfirmDelete(int id)
    {
        try
        {
            var response = await Http.DeleteAsync($"api/residuos/tipos/{id}");
            if (response.IsSuccessStatusCode)
            {
                NotificationService.ShowSuccess("Categoria removida.");
                await LoadData();
            }
            else
            {
                NotificationService.ShowError("Possui registros vinculados. Não pode ser excluída.");
            }
        }
        catch (Exception ex)
        {
            NotificationService.ShowError("Erro ao processar exclusão.");
        }
    }

}
