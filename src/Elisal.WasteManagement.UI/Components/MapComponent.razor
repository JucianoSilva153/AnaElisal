@implements IAsyncDisposable
@using Microsoft.JSInterop
@inject IJSRuntime JS
@using Elisal.WasteManagement.Domain.Entities

<div id="@MapId" style="height: 100%; width: 100%; min-height: 400px; border-radius: 0.5rem;"></div>

@code {
    [Parameter] public string MapId { get; set; } = "map";
    [Parameter] public List<CollectionPoint>? Points { get; set; }
    [Parameter] public EventCallback<double[]> OnMapClick { get; set; }
    [Parameter] public EventCallback<int> OnPointSelected { get; set; }
    [Parameter] public double InitialLat { get; set; } = -8.83833;
    [Parameter] public double InitialLng { get; set; } = 13.2344;
    [Parameter] public int InitialZoom { get; set; } = 12;

    private DotNetObjectReference<MapComponent>? _dotNetHelper;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                _dotNetHelper = DotNetObjectReference.Create(this);
                await JS.InvokeVoidAsync("mapFunctions.initMap", MapId, InitialLat, InitialLng, InitialZoom);
                await JS.InvokeVoidAsync("mapFunctions.setHelper", MapId, _dotNetHelper);
                
                if (Points != null && Points.Any())
                {
                    await JS.InvokeVoidAsync("mapFunctions.addMarkers", MapId, Points);
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error initializing map: {ex.Message}");
            }
        }
    }

    [JSInvokable]
    public async Task OnMapClickInternal(double lat, double lng)
    {
        if (OnMapClick.HasDelegate)
        {
            await OnMapClick.InvokeAsync(new[] { lat, lng });
        }
    }

    [JSInvokable]
    public async Task OnPointSelectedInternal(int pointId)
    {
        if (OnPointSelected.HasDelegate)
        {
            await OnPointSelected.InvokeAsync(pointId);
        }
    }

    public async ValueTask DisposeAsync()
    {
        _dotNetHelper?.Dispose();
    }
}
