@page "/"
@using Elisal.WasteManagement.Application.DTOs
@using Microsoft.AspNetCore.Components.Authorization
@using Elisal.WasteManagement.UI.Components.Dashboard
@inject HttpClient Http
@inject AuthenticationStateProvider AuthStateProvider

<PageTitle>SGR Elisal - Dashboard</PageTitle>

@if (stats == null)
{
    <div class="flex items-center justify-center h-[calc(100vh-160px)]">
        <div class="flex flex-col items-center gap-4">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary"></div>
            <p class="text-slate-500 text-sm font-medium animate-pulse">A carregar os seus dados...</p>
        </div>
    </div>
}
else
{
    <div class="p-4 sm:p-6 lg:p-8">
        @switch (userRole)
        {
            case "Admin":
                <AdminDashboard Stats="stats"/>
                break;
            case "Manager":
                <ManagerDashboard Stats="stats"/>
                break;
            case "Driver":
                <DriverDashboard Stats="stats"/>
                break;
            default:
                <AdminDashboard Stats="stats"/>
                break;
        }
    </div>
}

@code {
    private DashboardStatsDto? stats;
    private string userRole = "";

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        userRole = authState.User.FindFirst(System.Security.Claims.ClaimTypes.Role)?.Value ?? "";

        try
        {
            stats = await Http.GetFromJsonAsync<DashboardStatsDto>("api/dashboard/stats");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Erro ao carregar dashboard: {ex.Message}");
        }
    }

}
