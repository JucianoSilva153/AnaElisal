@page "/transacoes"
@inject HttpClient Http
@using Elisal.WasteManagement.Application.DTOs
@using Elisal.WasteManagement.Domain.Enums
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization

<PageTitle>SGR Elisal - Transações</PageTitle>

<div class="p-4 sm:p-6 lg:p-8 space-y-6 lg:space-y-8">
    <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4">
        <div>
            <h1 class="text-xl sm:text-2xl font-bold text-slate-900 dark:text-white">Transações com Cooperativas</h1>
            <p class="text-xs sm:text-sm text-slate-500 dark:text-slate-400 mt-1">Histórico de vendas de material reciclável</p>
        </div>
        <div class="flex flex-wrap gap-2 sm:gap-3">
            <button class="flex-1 sm:flex-none flex items-center justify-center gap-2 px-3 sm:px-4 py-2 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg text-slate-600 dark:text-slate-300 text-xs sm:text-sm font-medium hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors">
                <span class="material-symbols-outlined text-lg">download</span>
                Relatório
            </button>
            <AuthorizeView Roles="Admin,Manager">
                <button @onclick="() => _transacaoModal.Show()"
                        class="flex-1 sm:flex-none flex items-center justify-center gap-2 px-4 py-2 bg-primary hover:bg-primary/90 text-white rounded-lg text-sm font-bold transition-colors shadow-sm">
                    <span class="material-symbols-outlined text-lg">add_circle</span>
                    <span class="hidden sm:inline">Nova Transação</span>
                    <span class="sm:hidden">Nova</span>
                </button>
            </AuthorizeView>
        </div>
    </div>

    <!-- Filtros -->
    <div class="bg-white dark:bg-slate-900 rounded-xl border border-slate-200 dark:border-slate-800 shadow-sm p-4">
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
            <div>
                <label class="block text-[10px] font-semibold text-slate-500 uppercase mb-1">Data Início</label>
                <input type="date" @bind="startDate" class="w-full rounded-lg border-slate-300 dark:border-slate-700 bg-slate-50 dark:bg-slate-800 text-slate-900 dark:text-white p-2 text-sm focus:ring-primary focus:border-primary"/>
            </div>
            <div>
                <label class="block text-[10px] font-semibold text-slate-500 uppercase mb-1">Data Fim</label>
                <input type="date" @bind="endDate" class="w-full rounded-lg border-slate-300 dark:border-slate-700 bg-slate-50 dark:bg-slate-800 text-slate-900 dark:text-white p-2 text-sm focus:ring-primary focus:border-primary"/>
            </div>
            <div class="sm:col-span-2 lg:col-span-1">
                <label class="block text-[10px] font-semibold text-slate-500 uppercase mb-1">Cooperativa</label>
                <select @bind="selectedCoopId" class="w-full rounded-lg border-slate-300 dark:border-slate-700 bg-slate-50 dark:bg-slate-800 text-slate-900 dark:text-white p-2 text-sm focus:ring-primary focus:border-primary">
                    <option value="0">Todas</option>
                    @if (cooperativas != null)
                    {
                        @foreach (var c in cooperativas)
                        {
                            <option value="@c.Id">@c.Name</option>
                        }
                    }
                </select>
            </div>
            <div class="flex items-end lg:col-span-1">
                <button @onclick="LoadData" class="w-full px-4 py-2 bg-slate-900 dark:bg-slate-700 text-white rounded-lg text-sm font-medium hover:bg-slate-800 dark:hover:bg-slate-600 transition-colors flex items-center justify-center gap-2">
                    <span class="material-symbols-outlined text-lg">search</span> Filtrar
                </button>
            </div>
        </div>
    </div>

    <!-- Tabela -->
    <div class="bg-white dark:bg-slate-900 rounded-xl border border-slate-200 dark:border-slate-800 shadow-sm overflow-hidden">
        <div class="overflow-x-auto">
            <table class="w-full text-left">
                <thead class="bg-slate-50 dark:bg-slate-800/50">
                <tr>
                    <th class="text-left px-6 py-3 text-xs font-semibold text-slate-500 uppercase tracking-wider">Data</th>
                    <th class="text-left px-6 py-3 text-xs font-semibold text-slate-500 uppercase tracking-wider">Cooperativa</th>
                    <th class="text-left px-6 py-3 text-xs font-semibold text-slate-500 uppercase tracking-wider">Tipo Resíduo</th>
                    <th class="text-right px-6 py-3 text-xs font-semibold text-slate-500 uppercase tracking-wider">Qtd (Kg)</th>
                    <th class="text-right px-6 py-3 text-xs font-semibold text-slate-500 uppercase tracking-wider">Valor</th>
                    <th class="text-center px-6 py-3 text-xs font-semibold text-slate-500 uppercase tracking-wider">Estado</th>
                </tr>
                </thead>
                <tbody class="divide-y divide-slate-100 dark:divide-slate-800">
                @if (transacoes != null)
                {
                    @foreach (var t in transacoes)
                    {
                        <tr class="hover:bg-slate-50 dark:hover:bg-slate-800/50 transition-colors">
                            <td class="px-6 py-4 text-sm text-slate-600 dark:text-slate-400">@t.DateTime.ToString("dd/MM/yyyy")</td>
                            <td class="px-6 py-4 text-sm font-medium text-slate-900 dark:text-white">
                                @(cooperativas?.FirstOrDefault(c => c.Id == t.CooperativeId)?.Name ?? "—")
                            </td>
                            <td class="px-6 py-4 text-sm text-slate-600 dark:text-slate-400">
                                @(wasteTypes?.FirstOrDefault(w => w.Id == t.WasteTypeId)?.Name ?? "—")
                            </td>
                            <td class="px-6 py-4 text-sm text-right text-slate-600 dark:text-slate-400">@t.AmountKg.ToString("N1")</td>
                            <td class="px-6 py-4 text-sm text-right font-medium text-slate-900 dark:text-white">@t.TotalValue.ToString("C0")</td>
                            <td class="px-6 py-4 text-center">
                                <AuthorizeView Roles="Admin,Manager">
                                    <Authorized>
                                        <button @onclick="() => ToggleStatus(t)" class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium cursor-pointer transition-colors @GetStatusClass(t.Status)" title="Clique para alterar status">
                                            @GetStatusText(t.Status)
                                        </button>
                                    </Authorized>
                                    <NotAuthorized>
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium @GetStatusClass(t.Status)">
                                            @GetStatusText(t.Status)
                                        </span>
                                    </NotAuthorized>
                                </AuthorizeView>
                            </td>
                        </tr>
                    }
                }
                </tbody>
            </table>
        </div>
    </div>
</div>

<Elisal.WasteManagement.UI.Components.Modals.NovaTransacaoModal @ref="_transacaoModal" OnSaved="LoadData"/>

@code {
    private Elisal.WasteManagement.UI.Components.Modals.NovaTransacaoModal _transacaoModal;
    private List<TransactionDto>? transacoes;
    private List<CooperativeDto>? cooperativas;
    private List<WasteTypeDto>? wasteTypes;

    private DateTime startDate = DateTime.Today.AddMonths(-1);
    private DateTime endDate = DateTime.Today;
    private int selectedCoopId = 0;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            cooperativas = await Http.GetFromJsonAsync<List<CooperativeDto>>("api/cooperativas");
            wasteTypes = await Http.GetFromJsonAsync<List<WasteTypeDto>>("api/residuos/tipos");
        }
        catch
        {
        }

        await LoadData();
    }

    private async Task LoadData()
    {
        try
        {
            var url = $"api/cooperativas/transacoes?inicio={startDate:yyyy-MM-dd}&fim={endDate:yyyy-MM-dd}";
            if (selectedCoopId > 0) url += $"&coopId={selectedCoopId}";
            transacoes = await Http.GetFromJsonAsync<List<TransactionDto>>(url);
        }
        catch
        {
            transacoes = new();
        }
    }

    private async Task ToggleStatus(TransactionDto transaction)
    {
        var nextStatus = transaction.Status switch
        {
            TransactionStatus.Pending => "Completed",
            TransactionStatus.Completed => "Cancelled",
            TransactionStatus.Cancelled => "Pending",
            _ => "Pending"
        };

        try
        {
            var response = await Http.PutAsJsonAsync($"api/cooperativas/transacoes/{transaction.Id}/status", new { Status = nextStatus });
            if (response.IsSuccessStatusCode)
            {
                await LoadData();
            }
        }
        catch
        {
        }
    }

    private string GetStatusClass(TransactionStatus status) => status switch
    {
        TransactionStatus.Pending => "bg-yellow-100 text-yellow-800 hover:bg-yellow-200",
        TransactionStatus.Completed => "bg-green-100 text-green-800 hover:bg-green-200",
        TransactionStatus.Cancelled => "bg-red-100 text-red-800 hover:bg-red-200",
        _ => "bg-slate-100 text-slate-800"
    };

    private string GetStatusText(TransactionStatus status) => status switch
    {
        TransactionStatus.Pending => "Pendente",
        TransactionStatus.Completed => "Concluída",
        TransactionStatus.Cancelled => "Cancelada",
        _ => "—"
    };

}
