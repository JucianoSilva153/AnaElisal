@page "/perfil"
@inject HttpClient Http
@inject AuthenticationStateProvider AuthStateProvider
@inject Elisal.WasteManagement.UI.Services.LocalStorageService LocalStorage
@using Elisal.WasteManagement.Application.DTOs
@using Elisal.WasteManagement.Domain.Entities
@using Microsoft.AspNetCore.Authorization
@using System.Security.Claims

@attribute [Authorize]

<PageTitle>SGR Elisal - O Meu Perfil</PageTitle>

<div class="max-w-4xl mx-auto p-8 space-y-8">
    <div>
        <h1 class="text-2xl font-bold text-slate-900 dark:text-white">O Meu Perfil</h1>
        <p class="text-sm text-slate-500 dark:text-slate-400 mt-1">Gira as tuas informações pessoais e de acesso</p>
    </div>

    @if (showSuccess)
    {
        <div class="p-4 rounded-lg bg-green-50 border border-green-200 text-green-700 flex items-center gap-3">
            <span class="material-symbols-outlined">check_circle</span>
            <span>Perfil atualizado com sucesso!</span>
        </div>
    }
    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="p-4 rounded-lg bg-red-50 border border-red-200 text-red-700 flex items-center gap-3">
            <span class="material-symbols-outlined">error</span>
            <span>@errorMessage</span>
        </div>
    }

    <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
        <!-- Avatar & Basic Info -->
        <div class="md:col-span-1 space-y-6">
            <div class="bg-white dark:bg-slate-900 rounded-xl border border-slate-200 dark:border-slate-800 p-6 flex flex-col items-center text-center">
                <div class="size-24 rounded-full bg-primary flex items-center justify-center text-white text-3xl font-bold mb-4 shadow-lg">
                    @(  string.IsNullOrEmpty(user?.Name) ? "??" : user?.Name?[0].ToString().ToUpper() ?? "?")
                </div>
                <h2 class="text-xl font-bold text-slate-900 dark:text-white">@user?.Name</h2>
                <p class="text-sm text-slate-500">@user?.Role.ToString()</p>
            </div>
        </div>

        <!-- Forms -->
        <div class="md:col-span-2 space-y-6">
            <!-- Informações Pessoais -->
            <div class="bg-white dark:bg-slate-900 rounded-xl border border-slate-200 dark:border-slate-800 shadow-sm overflow-hidden">
                <div class="px-6 py-4 border-b border-slate-100 dark:border-slate-800 bg-slate-50/50 dark:bg-slate-800/50">
                    <h3 class="font-bold text-slate-900 dark:text-white">Informações Pessoais</h3>
                </div>
                <div class="p-6 space-y-4">
                    <div class="grid grid-cols-1 gap-4">
                        <div class="space-y-1">
                            <label class="text-xs font-semibold text-slate-500 uppercase">Nome Completo</label>
                            <input type="text" @bind="user.Name" class="w-full rounded-lg border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800 text-slate-900 dark:text-white p-2.5" />
                        </div>
                        <div class="space-y-1">
                            <label class="text-xs font-semibold text-slate-500 uppercase">Email</label>
                            <input type="email" @bind="user.Email" class="w-full rounded-lg border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800 text-slate-900 dark:text-white p-2.5" />
                        </div>
                    </div>
                    <div class="pt-4">
                        <button @onclick="UpdateProfile" class="px-6 py-2 bg-primary text-white rounded-lg text-sm font-bold hover:bg-primary/90 transition-colors">
                            Salvar Alterações
                        </button>
                    </div>
                </div>
            </div>

            <!-- Alterar Senha -->
            <div class="bg-white dark:bg-slate-900 rounded-xl border border-slate-200 dark:border-slate-800 shadow-sm overflow-hidden">
                <div class="px-6 py-4 border-b border-slate-100 dark:border-slate-800 bg-slate-50/50 dark:bg-slate-800/50">
                    <h3 class="font-bold text-slate-900 dark:text-white">Alterar Senha</h3>
                </div>
                <div class="p-6 space-y-4">
                    <div class="grid grid-cols-1 gap-4">
                        <div class="space-y-1">
                            <label class="text-xs font-semibold text-slate-500 uppercase">Senha Atual</label>
                            <input type="password" @bind="currentPassword" class="w-full rounded-lg border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800 text-slate-900 dark:text-white p-2.5" />
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="space-y-1">
                                <label class="text-xs font-semibold text-slate-500 uppercase">Nova Senha</label>
                                <input type="password" @bind="newPassword" class="w-full rounded-lg border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800 text-slate-900 dark:text-white p-2.5" />
                            </div>
                            <div class="space-y-1">
                                <label class="text-xs font-semibold text-slate-500 uppercase">Confirmar Nova Senha</label>
                                <input type="password" @bind="confirmPassword" class="w-full rounded-lg border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800 text-slate-900 dark:text-white p-2.5" />
                            </div>
                        </div>
                    </div>
                    <div class="pt-4">
                        <button @onclick="UpdatePassword" class="px-6 py-2 bg-slate-900 dark:bg-slate-700 text-white rounded-lg text-sm font-bold hover:bg-slate-800 dark:hover:bg-slate-600 transition-colors">
                            Atualizar Senha
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private UserDto user = new();
    private string currentPassword = "";
    private string newPassword = "";
    private string confirmPassword = "";
    private bool showSuccess = false;
    private string errorMessage = "";

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var email = authState.User.Claims.FirstOrDefault(c => c.Type == "email");

        if (string.IsNullOrEmpty(email?.Value)) return;

        try
        {
            // Usually we have a /me endpoint
            var allUsers = await Http.GetFromJsonAsync<List<UserDto>>("api/usuarios");
            user = allUsers?.FirstOrDefault(u => u.Email == email.Value) ?? new();
        }
        catch
        {
        }
    }

    private async Task UpdateProfile()
    {
        showSuccess = false;
        errorMessage = "";
        try
        {
            var userUpdate = new UpdateUserDto
            {
                Nome = user.Name
            };

            var response = await Http.PutAsJsonAsync($"api/usuarios/{user.Id}", userUpdate);
            if (response.IsSuccessStatusCode)
            {
                showSuccess = true;
                // Update cached user in localStorage if needed
            }
            else
            {
                errorMessage = "Erro ao atualizar perfil.";
            }
        }
        catch (Exception ex)
        {
            errorMessage = ex.Message;
        }
    }

    private async Task UpdatePassword()
    {
        showSuccess = false;
        errorMessage = "";

        if (newPassword != confirmPassword)
        {
            errorMessage = "As novas senhas não coincidem.";
            return;
        }

        try
        {
            var response = await Http.PostAsJsonAsync($"api/usuarios/{user.Id}/alterar-senha", new { CurrentPassword = currentPassword, NewPassword = newPassword });
            if (response.IsSuccessStatusCode)
            {
                showSuccess = true;
                currentPassword = newPassword = confirmPassword = "";
            }
            else
            {
                errorMessage = "Erro ao alterar senha. Verifique a senha atual.";
            }
        }
        catch (Exception ex)
        {
            errorMessage = ex.Message;
        }
    }

}
